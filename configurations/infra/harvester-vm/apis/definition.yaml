apiVersion: apiextensions.crossplane.io/v2
kind: CompositeResourceDefinition
metadata:
  name: harvestervms.resources.stuttgart-things.com
spec:
  group: resources.stuttgart-things.com
  defaultCompositeDeletePolicy: Foreground
  scope: Namespaced
  names:
    kind: HarvesterVM
    plural: harvestervms
    singular: harvestervm
  versions:
    - name: v1alpha1
      served: true
      referenceable: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              required:
                - providerConfigRef
                - volume
                - cloudInit
                - vm
              properties:
                providerConfigRef:
                  type: string
                  description: "Name of the ProviderConfig for Kubernetes operations"

                #################################
                # Volume Claim Configuration
                #################################
                volume:
                  type: object
                  required:
                    - pvcName
                    - storageClassName
                  properties:
                    pvcName:
                      type: string
                    namespace:
                      type: string
                      default: "default"
                    storageClassName:
                      type: string
                    storage:
                      type: string
                      default: "10Gi"
                    accessModes:
                      type: array
                      items:
                        type: string
                      default:
                        - "ReadWriteOnce"
                    volumeMode:
                      type: string
                      default: "Filesystem"
                    annotations:
                      type: object
                      additionalProperties:
                        type: string
                    labels:
                      type: object
                      additionalProperties:
                        type: string
                    selector:
                      type: object
                      properties:
                        matchLabels:
                          type: object
                          additionalProperties:
                            type: string
                        matchExpressions:
                          type: array
                          items:
                            type: object
                            properties:
                              key:
                                type: string
                              operator:
                                type: string
                              values:
                                type: array
                                items:
                                  type: string
                    dataSource:
                      type: object
                      properties:
                        name:
                          type: string
                        kind:
                          type: string
                        apiGroup:
                          type: string

                #################################
                # Cloud-Init Configuration
                #################################
                cloudInit:
                  type: object
                  required:
                    - vmName
                    - hostname
                  properties:
                    vmName:
                      type: string
                    namespace:
                      type: string
                      default: "vms"
                    hostname:
                      type: string
                    domain:
                      type: string
                      default: "local"
                    timezone:
                      type: string
                    users:
                      type: array
                      items:
                        type: object
                        properties:
                          name:
                            type: string
                          sshAuthorizedKeys:
                            type: array
                            items:
                              type: string
                          sudo:
                            type: string
                          groups:
                            type: string
                          shell:
                            type: string
                          password:
                            type: string
                          lockPasswd:
                            type: boolean
                    packages:
                      type: array
                      items:
                        type: string
                    writeFiles:
                      type: array
                      items:
                        type: object
                        properties:
                          path:
                            type: string
                          content:
                            type: string
                          owner:
                            type: string
                          permissions:
                            type: string
                          encoding:
                            type: string
                    runcmd:
                      type: array
                      items:
                        type: string
                    bootcmd:
                      type: array
                      items:
                        type: string
                    packageUpdate:
                      type: boolean
                      default: true
                    packageUpgrade:
                      type: boolean
                      default: false
                    sshPasswordAuth:
                      type: boolean
                      default: false
                    disableRoot:
                      type: boolean
                      default: true
                    networkConfig:
                      type: string

                #################################
                # VirtualMachine Configuration (NEW)
                #################################
                vm:
                  type: object
                  description: "KubeVirt / Harvester VirtualMachine configuration"
                  required:
                    - cpu
                    - resources
                  properties:
                    description:
                      type: string

                    runStrategy:
                      type: string
                      default: "RerunOnFailure"

                    evictionStrategy:
                      type: string
                      default: "LiveMigrateIfPossible"

                    terminationGracePeriodSeconds:
                      type: integer
                      default: 120

                    os:
                      type: string
                      default: "ubuntu"

                    machineType:
                      type: string
                      default: "q35"

                    cpu:
                      type: object
                      required:
                        - cores
                      properties:
                        cores:
                          type: integer
                        sockets:
                          type: integer
                          default: 1
                        threads:
                          type: integer
                          default: 1

                    resources:
                      type: object
                      required:
                        - memory
                        - cpu
                      properties:
                        memory:
                          type: string
                        cpu:
                          type: string

                    disks:
                      type: array
                      items:
                        type: object
                        required:
                          - name
                        properties:
                          name:
                            type: string
                          bus:
                            type: string
                            default: "virtio"
                          bootOrder:
                            type: integer

                    networks:
                      type: array
                      items:
                        type: object
                        required:
                          - name
                          - networkName
                        properties:
                          name:
                            type: string
                          networkName:
                            type: string

            #################################
            # Status
            #################################
            status:
              type: object
              properties:
                volume:
                  type: object
                  properties:
                    pvcName:
                      type: string
                    ready:
                      type: boolean
                cloudInit:
                  type: object
                  properties:
                    secretName:
                      type: string
                    ready:
                      type: boolean
                vm:
                  type: object
                  properties:
                    name:
                      type: string
                    ready:
                      type: boolean
