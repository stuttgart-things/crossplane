apiVersion: apiextensions.crossplane.io/v2
kind: CompositeResourceDefinition
metadata:
  name: harvestervms.resources.stuttgart-things.com
spec:
  group: resources.stuttgart-things.com
  defaultCompositeDeletePolicy: Foreground
  scope: Namespaced
  names:
    kind: HarvesterVM
    plural: harvestervms
    singular: harvestervm
  versions:
    - name: v1alpha1
      served: true
      referenceable: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              required:
                - providerConfigRef
                - vm
                - volume
                - cloudInit
              properties:
                providerConfigRef:
                  type: string
                  description: Name of the ProviderConfig for Kubernetes operations

                # --------------------
                # VM Configuration
                # --------------------
                vm:
                  type: object
                  required:
                    - name
                    - namespace
                    - vmName
                    - hostname
                    - osLabel
                    - cpuCores
                    - memory
                  properties:
                    name:
                      type: string
                    namespace:
                      type: string
                      default: vms
                    vmName:
                      type: string
                    hostname:
                      type: string
                    description:
                      type: string

                    osLabel:
                      type: string
                      description: OS image label (e.g. ubuntu)

                    runStrategy:
                      type: string
                      default: RerunOnFailure

                    cpuCores:
                      type: integer
                      minimum: 1
                    cpuSockets:
                      type: integer
                      default: 1
                    cpuThreads:
                      type: integer
                      default: 1

                    memory:
                      type: string
                      description: VM memory (e.g. 8Gi)

                    diskName:
                      type: string
                      default: disk-0

                    machineType:
                      type: string
                      default: q35

                    networkNamespace:
                      type: string
                      default: default
                    networkName:
                      type: string
                      default: default

                    evictionStrategy:
                      type: string
                      default: LiveMigrateIfPossible

                    terminationGracePeriod:
                      type: integer
                      default: 120

                # --------------------
                # Volume Claim Configuration
                # --------------------
                volume:
                  type: object
                  required:
                    - pvcName
                    - storageClassName
                  properties:
                    pvcName:
                      type: string
                    namespace:
                      type: string
                      default: default
                    storageClassName:
                      type: string
                    storage:
                      type: string
                      default: 10Gi
                    accessModes:
                      type: array
                      items:
                        type: string
                      default:
                        - ReadWriteOnce
                    volumeMode:
                      type: string
                      default: Filesystem
                    annotations:
                      type: object
                      additionalProperties:
                        type: string
                    labels:
                      type: object
                      additionalProperties:
                        type: string

                # --------------------
                # Cloud-Init Configuration
                # --------------------
                cloudInit:
                  type: object
                  required:
                    - vmName
                    - hostname
                  properties:
                    vmName:
                      type: string
                    namespace:
                      type: string
                      default: vms
                    hostname:
                      type: string
                    domain:
                      type: string
                      default: local
                    timezone:
                      type: string
                    users:
                      type: array
                      items:
                        type: object
                        properties:
                          name:
                            type: string
                          sshAuthorizedKeys:
                            type: array
                            items:
                              type: string
                          sudo:
                            type: string
                          groups:
                            type: string
                          shell:
                            type: string
                          password:
                            type: string
                          lockPasswd:
                            type: boolean
                    packages:
                      type: array
                      items:
                        type: string
                    writeFiles:
                      type: array
                      items:
                        type: object
                        properties:
                          path:
                            type: string
                          content:
                            type: string
                          owner:
                            type: string
                          permissions:
                            type: string
                          encoding:
                            type: string
                    runcmd:
                      type: array
                      items:
                        type: string
                    bootcmd:
                      type: array
                      items:
                        type: string
                    packageUpdate:
                      type: boolean
                      default: true
                    packageUpgrade:
                      type: boolean
                      default: false
                    sshPasswordAuth:
                      type: boolean
                      default: false
                    disableRoot:
                      type: boolean
                      default: true
                    networkConfig:
                      type: string

            status:
              type: object
              properties:
                vm:
                  type: object
                  properties:
                    ready:
                      type: boolean
                    id:
                      type: string
                volume:
                  type: object
                  properties:
                    pvcName:
                      type: string
                    ready:
                      type: boolean
                cloudInit:
                  type: object
                  properties:
                    secretName:
                      type: string
                    ready:
                      type: boolean
